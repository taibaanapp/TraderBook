<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockPulse Standalone Terminal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Date Fns -->
    <script src="https://unpkg.com/date-fns@2.30.0/dist/date-fns.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #18181b;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-[#F8F9FA] text-zinc-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            AreaChart, Area, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, Line
        } = Recharts;

        // Icons mapping
        const Icon = ({ name, className }) => {
            const [svg, setSvg] = useState('');
            useEffect(() => {
                if (window.lucide) {
                    const icon = window.lucide.icons[name];
                    if (icon) setSvg(icon.toSvg({ class: className }));
                }
            }, [name, className]);
            return <span dangerouslySetInnerHTML={{ __html: svg }} />;
        };

        function App() {
            const [symbol, setSymbol] = useState('AAPL');
            const [searchInput, setSearchInput] = useState('AAPL');
            const [stockData, setStockData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [showVWAP, setShowVWAP] = useState(false);
            const [showOBV, setShowOBV] = useState(false);
            const [activeTab, setActiveTab] = useState('chart');

            // Portfolio State
            const [transactions, setTransactions] = useState(() => {
                const saved = localStorage.getItem('standalone_stock_transactions');
                return saved ? JSON.parse(saved) : [];
            });
            const [newTx, setNewTx] = useState({
                type: 'BUY',
                shares: 0,
                price: 0,
                date: new Date().toISOString().split('T')[0]
            });
            const [simAdditionalShares, setSimAdditionalShares] = useState(0);

            const fetchData = async (targetSymbol) => {
                setLoading(true);
                setError(null);
                try {
                    // Using AllOrigins CORS Proxy
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${targetSymbol}?interval=1d&range=5y`;
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    
                    const response = await fetch(proxyUrl);
                    const json = await response.json();
                    const data = JSON.parse(json.contents);

                    if (!data.chart.result) throw new Error("Symbol not found");

                    const result = data.chart.result[0];
                    const timestamps = result.timestamp;
                    const quotes = result.indicators.quote[0];
                    
                    const formattedData = timestamps.map((t, i) => {
                        const close = quotes.close[i];
                        const volume = quotes.volume[i] || 0;
                        
                        // Volume Color Logic (MA5)
                        let volumeColor = '#18181b';
                        if (i >= 5) {
                            const prev5 = quotes.volume.slice(i - 5, i);
                            const avg = prev5.reduce((a, b) => a + (b || 0), 0) / 5;
                            if (volume > avg) volumeColor = '#10b981';
                            else if (volume < avg) volumeColor = '#f43f5e';
                        }

                        return {
                            date: new Date(t * 1000).toISOString(),
                            open: quotes.open[i],
                            high: quotes.high[i],
                            low: quotes.low[i],
                            close: close,
                            volume: volume,
                            volumeColor: volumeColor
                        };
                    }).filter(d => d.close !== null);

                    setStockData({ symbol: targetSymbol, data: formattedData });
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchData(symbol); }, [symbol]);

            const processedData = useMemo(() => {
                if (!stockData?.data) return [];
                let cumulativeTPV = 0;
                let cumulativeVolume = 0;
                let currentOBV = 0;
                
                return stockData.data.map((point, i, arr) => {
                    const typicalPrice = (point.high + point.low + point.close) / 3;
                    cumulativeTPV += typicalPrice * point.volume;
                    cumulativeVolume += point.volume;
                    const vwap = cumulativeTPV / cumulativeVolume;
                    
                    if (i > 0) {
                        if (point.close > arr[i-1].close) currentOBV += point.volume;
                        else if (point.close < arr[i-1].close) currentOBV -= point.volume;
                    } else currentOBV = point.volume;
                    
                    return { ...point, vwap, obv: currentOBV };
                });
            }, [stockData]);

            const portfolioSummaries = useMemo(() => {
                const summaries = {};
                transactions.forEach(tx => {
                    if (!summaries[tx.symbol]) summaries[tx.symbol] = { symbol: tx.symbol, totalShares: 0, avgCost: 0, totalCost: 0 };
                    const s = summaries[tx.symbol];
                    if (tx.type === 'BUY') {
                        s.totalCost += (tx.shares * tx.price);
                        s.totalShares += tx.shares;
                        s.avgCost = s.totalShares > 0 ? s.totalCost / s.totalShares : 0;
                    } else {
                        s.totalShares -= tx.shares;
                        s.totalCost = s.totalShares * s.avgCost;
                    }
                });
                return Object.values(summaries).filter(s => s.totalShares > 0);
            }, [transactions]);

            const currentSummary = portfolioSummaries.find(s => s.symbol === symbol) || { symbol, totalShares: 0, avgCost: 0 };
            const latestPrice = stockData?.data[stockData.data.length - 1]?.close;

            const addTransaction = () => {
                if (newTx.shares <= 0 || newTx.price <= 0) return;
                const tx = { id: Date.now().toString(), symbol, ...newTx };
                const updated = [...transactions, tx];
                setTransactions(updated);
                localStorage.setItem('standalone_stock_transactions', JSON.stringify(updated));
                setNewTx({ ...newTx, shares: 0, price: 0 });
            };

            const lineGradientStops = useMemo(() => {
                if (!processedData.length) return null;
                return processedData.map((p, i) => (
                    <stop key={i} offset={`${(i / (processedData.length - 1)) * 100}%`} stopColor={p.volumeColor} />
                ));
            }, [processedData]);

            return (
                <div className="min-h-screen">
                    <header className="border-b border-zinc-200 bg-white sticky top-0 z-10 px-8 h-16 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-zinc-900 rounded-xl flex items-center justify-center text-white font-bold">SP</div>
                            <h1 className="text-lg font-bold tracking-tight">StockPulse Standalone</h1>
                        </div>
                        <form onSubmit={(e) => { e.preventDefault(); setSymbol(searchInput.toUpperCase()); }} className="flex-1 max-w-md mx-8">
                            <input
                                type="text"
                                value={searchInput}
                                onChange={(e) => setSearchInput(e.target.value)}
                                placeholder="Search symbol (e.g. AAPL, BTC-USD)"
                                className="w-full bg-zinc-100 border-transparent focus:bg-white focus:border-zinc-900 rounded-xl px-4 py-2 text-sm outline-none border"
                            />
                        </form>
                        <div className="flex gap-2">
                            <button onClick={() => setActiveTab('chart')} className={`px-4 py-1.5 text-xs font-bold rounded-md ${activeTab === 'chart' ? 'bg-zinc-900 text-white' : 'text-zinc-500'}`}>Chart</button>
                            <button onClick={() => setActiveTab('portfolio')} className={`px-4 py-1.5 text-xs font-bold rounded-md ${activeTab === 'portfolio' ? 'bg-zinc-900 text-white' : 'text-zinc-500'}`}>Portfolio</button>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-8 py-8">
                        {loading ? (
                            <div className="flex flex-col items-center justify-center py-20 gap-4">
                                <div className="w-8 h-8 border-4 border-zinc-900 border-t-transparent rounded-full animate-spin"></div>
                                <p className="text-xs font-bold uppercase tracking-widest text-zinc-400">Loading Market Data...</p>
                            </div>
                        ) : error ? (
                            <div className="bg-red-50 p-8 rounded-2xl text-center border border-red-100">
                                <p className="text-red-600 font-bold mb-4">{error}</p>
                                <button onClick={() => fetchData(symbol)} className="bg-red-600 text-white px-6 py-2 rounded-xl text-sm font-bold">Try Again</button>
                            </div>
                        ) : activeTab === 'chart' ? (
                            <div className="grid grid-cols-4 gap-8">
                                <div className="col-span-3 space-y-8">
                                    <div className="bg-white p-6 rounded-2xl border border-zinc-200 flex justify-between items-end">
                                        <div>
                                            <h2 className="text-4xl font-black tracking-tighter">{symbol}</h2>
                                            <p className="text-2xl font-bold text-zinc-900">${latestPrice?.toFixed(2)}</p>
                                        </div>
                                        <div className="flex gap-4">
                                            <button onClick={() => setShowVWAP(!showVWAP)} className={`px-3 py-1 text-[10px] font-bold rounded border ${showVWAP ? 'bg-blue-600 text-white border-blue-600' : 'text-zinc-400 border-zinc-200'}`}>VWAP</button>
                                            <button onClick={() => setShowOBV(!showOBV)} className={`px-3 py-1 text-[10px] font-bold rounded border ${showOBV ? 'bg-zinc-900 text-white border-zinc-900' : 'text-zinc-400 border-zinc-200'}`}>OBV</button>
                                        </div>
                                    </div>

                                    <div className="bg-white p-6 rounded-2xl border border-zinc-200 h-[500px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <AreaChart data={processedData}>
                                                <defs>
                                                    <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">{lineGradientStops}</linearGradient>
                                                </defs>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f1f1" />
                                                <XAxis dataKey="date" hide />
                                                <YAxis domain={['auto', 'auto']} orientation="right" tick={{fontSize: 10}} axisLine={false} tickLine={false} />
                                                <Tooltip />
                                                <Area type="monotone" dataKey="close" stroke="url(#lineGradient)" strokeWidth={2} fill="#18181b" fillOpacity={0.05} />
                                                {showVWAP && <Line type="monotone" dataKey="vwap" stroke="#2563eb" strokeWidth={2} dot={false} />}
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    </div>

                                    {showOBV && (
                                        <div className="bg-white p-6 rounded-2xl border border-zinc-200 h-[200px]">
                                            <h3 className="text-[10px] font-bold uppercase tracking-widest text-zinc-400 mb-4">On-Balance Volume</h3>
                                            <ResponsiveContainer width="100%" height="100%">
                                                <AreaChart data={processedData}>
                                                    <Area type="monotone" dataKey="obv" stroke="#18181b" fill="#18181b" fillOpacity={0.05} />
                                                </AreaChart>
                                            </ResponsiveContainer>
                                        </div>
                                    )}

                                    <div className="bg-white p-6 rounded-2xl border border-zinc-200 h-[200px]">
                                        <h3 className="text-[10px] font-bold uppercase tracking-widest text-zinc-400 mb-4">Volume</h3>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={processedData}>
                                                <Bar dataKey="volume">
                                                    {processedData.map((e, i) => <Cell key={i} fill={e.volumeColor} />)}
                                                </Bar>
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                <div className="space-y-6">
                                    <div className="bg-zinc-900 p-6 rounded-2xl text-white">
                                        <h3 className="text-[10px] font-bold uppercase tracking-widest text-zinc-500 mb-4">Portfolio Quick View</h3>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><p className="text-[10px] text-zinc-500 uppercase font-bold">Shares</p><p className="font-bold">{currentSummary.totalShares}</p></div>
                                            <div><p className="text-[10px] text-zinc-500 uppercase font-bold">Avg Cost</p><p className="font-bold">${currentSummary.avgCost.toFixed(2)}</p></div>
                                        </div>
                                    </div>

                                    <div className="bg-white p-6 rounded-2xl border border-zinc-200">
                                        <h3 className="text-[10px] font-bold uppercase tracking-widest text-zinc-400 mb-4">DCA Simulator</h3>
                                        <input type="range" min="0" max="500" value={simAdditionalShares} onChange={e => setSimAdditionalShares(Number(e.target.value))} className="w-full h-1 bg-zinc-100 rounded-lg appearance-none mb-4" />
                                        <div className="bg-zinc-50 p-4 rounded-xl space-y-2">
                                            <div className="flex justify-between text-[10px] font-bold uppercase text-zinc-400"><span>Buy More</span><span className="text-zinc-900">+{simAdditionalShares} Shares</span></div>
                                            <div className="flex justify-between text-sm font-bold"><span>New Avg</span><span className="text-emerald-600">${((currentSummary.totalShares * currentSummary.avgCost + simAdditionalShares * (latestPrice || 0)) / (currentSummary.totalShares + simAdditionalShares || 1)).toFixed(2)}</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="grid grid-cols-3 gap-8">
                                <div className="col-span-2 bg-white p-8 rounded-2xl border border-zinc-200">
                                    <h2 className="text-2xl font-black mb-6">Portfolio Overview</h2>
                                    <table className="w-full text-sm">
                                        <thead><tr className="text-left text-zinc-400 uppercase text-[10px] font-bold border-b"><th className="pb-4">Asset</th><th className="pb-4 text-right">Shares</th><th className="pb-4 text-right">Avg Cost</th></tr></thead>
                                        <tbody>
                                            {portfolioSummaries.map(s => (
                                                <tr key={s.symbol} className="border-b"><td className="py-4 font-bold">{s.symbol}</td><td className="py-4 text-right font-bold">{s.totalShares}</td><td className="py-4 text-right font-bold">${s.avgCost.toFixed(2)}</td></tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="bg-zinc-900 p-8 rounded-2xl text-white">
                                    <h2 className="text-xl font-black mb-6">Add Transaction</h2>
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-2 gap-2 p-1 bg-zinc-800 rounded-lg">
                                            <button onClick={() => setNewTx({...newTx, type: 'BUY'})} className={`py-2 text-[10px] font-bold uppercase rounded ${newTx.type === 'BUY' ? 'bg-emerald-600' : ''}`}>Buy</button>
                                            <button onClick={() => setNewTx({...newTx, type: 'SELL'})} className={`py-2 text-[10px] font-bold uppercase rounded ${newTx.type === 'SELL' ? 'bg-rose-600' : ''}`}>Sell</button>
                                        </div>
                                        <input type="number" placeholder="Shares" value={newTx.shares || ''} onChange={e => setNewTx({...newTx, shares: Number(e.target.value)})} className="w-full bg-zinc-800 rounded-lg px-4 py-2 text-sm outline-none" />
                                        <input type="number" placeholder="Price" value={newTx.price || ''} onChange={e => setNewTx({...newTx, price: Number(e.target.value)})} className="w-full bg-zinc-800 rounded-lg px-4 py-2 text-sm outline-none" />
                                        <button onClick={addTransaction} className="w-full bg-white text-zinc-900 py-3 rounded-xl font-black text-xs uppercase">Save</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
